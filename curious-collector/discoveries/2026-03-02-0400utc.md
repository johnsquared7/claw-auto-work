# Discovery — 2026-03-02 0400UTC

**Focus:** SQL Optimization for Healthcare, Python Report Automation Patterns

---

## 1. SQL Optimization for NHS Data Warehouses

**Key patterns for healthcare query performance:**

### Indexing Strategies for NHS Data
- **Composite indexes** on frequently filtered columns (e.g., `CREATE INDEX ix_admissions_date_type ON admissions(admission_date, admission_type)`)
- **Clustered indexes** on date columns for time-series NHS data
- **Covering indexes** to avoid key lookups for common report queries

### Query Patterns to Avoid
| Pattern | Problem | Fix |
|---------|---------|-----|
| `SELECT *` | Pulls unnecessary columns | Specify only needed columns |
| Nested subqueries | Poor execution plans | Use CTEs (WITH clauses) |
| Implicit conversions | Full table scans | Use explicit CAST |
| Functions on indexed columns | Prevents index usage | Filter first, then apply |

### NHS SQL Server Specific
```sql
-- Find slow queries (NHS SQL Server)
SELECT TOP 20 
    total_elapsed_time / execution_count AS avg_time,
    total_logical_reads / execution_count AS avg_reads,
    execution_count,
    total_worker_time,
    total_elapsed_time,
    st.text
FROM sys.dm_exec_query_stats qs
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) st
ORDER BY avg_time DESC;
```

### Window Functions for Healthcare Analytics
Window functions are underused in NHS reporting:
```sql
-- Running totals for admissions
SELECT 
    admission_date,
    daily_admissions,
    SUM(daily_admissions) OVER (ORDER BY admission_date) AS running_total
FROM admissions;
```

---

## 2. Python Report Automation — Specific Stack

**Complete stack for NHS automated reports:**

### Data Layer
- **sqlalchemy** + **pyodbc** — Connect to NHS SQL Server
- **pandas** — Data manipulation
- **duckdb** — Fast local analytics on exports

### Report Generation
- **jinja2** — Template-based HTML reports
- **weasyprint** or **reportlab** — HTML to PDF
- **xlsxwriter** — Excel with formatting (NHS preference)

### Scheduling
- **schedule** library (simple) or
- **cron** + Python script (robust)
- **airflow** (if enterprise-scale)

### Email
- **smtplib** (simple) or
- **aiosmtpd** (async) or
- Microsoft Graph API (if NHS 365)

**Minimal viable automation script:**
```python
import pandas as pd
from sqlalchemy import create_engine
import jinja2
import weasyprint
import schedule
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.mime.application import MIMEApplication

def generate_weekly_report():
    # 1. Fetch data
    engine = create_engine("mssql+pyodbc://user:pass@server/NHSDB")
    df = pd.read_sql("SELECT * FROM weekly_admissions", engine)
    
    # 2. Render template
    template = jinja2.Environment().from_string(html_template)
    html = template.render(data=df.to_dict('records'))
    
    # 3. Convert to PDF
    pdf = weasyprint.HTML(string=html).write_pdf()
    
    # 4. Email
    msg = MIMEMultipart()
    msg['To'] = 'team@nhs.uk'
    msg['Subject'] = 'Weekly Admissions Report'
    msg.attach(MIMEText(html, 'html'))
    msg.attach(MIMEApplication(pdf, Name='report.pdf'))
    
    with smtplib.SMTP('smtp.nhs.net') as server:
        server.send_message(msg)

schedule.every().monday.at("08:00").do(generate_weekly_report)
```

---

## 3. Quarto — Document Automation for Analysts

**What:** Open-source scientific publishing system (from RStudio/Posit).

**Why it matters for NHS:**
- Write reports in Markdown, render to HTML/PDF/Word
- Embed SQL queries that execute at build time
- Perfect for reproducible analytical reports
- Used by NHS-R community

**Workflow:**
1. Write `.qmd` file with SQL chunks
2. Connect to SQL Server
3. Render → automated report with fresh data

**Links:**
- https://quarto.org/
- NHS-R examples: https://github.com/nhs-r-community

---

## 4. Great Expectations — Data Quality for NHS

**What:** Python library for data validation and documentation.

**Why NHS analysts need it:**
- Automated data quality checks on NHS datasets
- Documented expectations (like "admission_date is not null")
- Generate data quality reports automatically
- Integrates with SQL Server, pandas, Spark

**Use case:** Validate waiting list data before generating reports — catch missing/spurious data automatically.

```python
import great_expectations as gx

expectation_suite = gx.from_pandas(df).expect_column_values_to_not_be_null("patient_id")
```

**Link:** https://greatexpectations.io/

---

## 5. SQL Fluff — Lint Your SQL

**What:** SQL linter and formatter.

**For NHS teams:**
- Enforce coding standards across team
- Catch performance issues early
- Auto-format SQL for readability

```bash
pip install sqlfluff
sqlfluff lint query.sql --dialect tsql
sqlfluff fix query.sql --dialect tsql
```

**Link:** https://sqlfluff.com/

---

## 6. MCP (Model Context Protocol) — AI-Powered Analytics

**Emerging 2026:** MCP enables AI assistants to connect directly to databases. For NHS:

- Ask AI: "Show me admission trends for the last 12 weeks"
- AI executes SQL, generates chart, returns insights
- Microsoft, Anthropic supporting this protocol

**Link:** https://modelcontextprotocol.io/

---

## Summary — Actionable for John

| Area | Tool | Next Step |
|------|------|-----------|
| SQL Performance | sys.dm_exec_query_stats | Run the diagnostic query on NHS DB |
| Report Automation | Jinja2 + Weasyprint | Build one template report |
| Data Quality | Great Expectations | Add one expectation check |
| Document Reports | Quarto | Try rendering a .qmd with SQL |
| SQL Linting | SQLFluff | Add to VS Code for TSQL |

---

*Discovery cycle: 2026-03-02 0400UTC | Focus: SQL optimization + Python automation | Source: Web search*
